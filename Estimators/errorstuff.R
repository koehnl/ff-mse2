#dput(test.ts)
test.ts <- c(129789.515264376, 210225.689016428, 268467.703826785, 390605.718199136, 
             398058.028152439, 397317.576521293, 360216.249031858, 358584.595820034, 
             374015.187600488, 362224.684859305, 371147.038673146, 404184.489106397, 
             389994.959295287, 351420.56978121, 303666.001497289, 310247.172419505, 
             267872.665629737, 239347.52564811, 233028.841189334, 222568.235673551, 
             199544.211486687, 332978.911714067, 333917.366599796, 288795.717225616, 
             251271.735677016, 273175.261202967, 275501.190600482, 256436.442312402, 
             274346.582696408, 245027.413820601, 249175.265550952, 268042.576659346, 
             275516.332286576, 390729.044066523, 404026.774845868, 353527.106073577, 
             315367.975843293, 279770.522088034, 252692.554465204, 328302.904446572, 
             419058.124920692, 401525.496684259, 338971.232502377, 272203.115479247, 
             236587.079049355, 424095.636676746, 428525.712489264, 915853.724972788, 
             893033.843413122, 792664.008861404, 600808.705001503, 535044.732324148, 
             406553.571173287, 336332.678870855, 314980.063468339, 263381.666983163, 
             343581.234014685, 314591.096700864, 275885.90003448, 269674.606114247, 
             285701.378309266, 252090.976657969, 251580.123758436, 245163.966911859, 
             299507.852301127, 275333.60565594, 270393.952563849, 305106.323954432, 
             297652.264429497, 232627.318357265, 221961.502842963, 211044.239343078, 
             255357.309047744, 229604.819583981, 202242.367967422, 195856.959975824, 
             340296.572716029, 494339.06515325, 457841.840336649, 422972.656936782, 
             457723.586955825, 500911.433226332, 440822.424907612, 594920.36691903, 
             572725.22303018, 480532.530433948, 360052.016150341, 338472.274859629, 
             257437.224712492, 272527.518274236, 372553.146639552, 370992.999731516, 
             305588.498260761, 270279.853871565, 277551.839477969, 239371.417230272, 
             212528.858937404, 217231.464749512, 313824.791420375, 390237.19009219, 
             361535.129286824, 339711.047785791, 313087.726793119, 267748.168614384, 
             209094.617971645, 289710.879318541, 260226.845325311, 211903.610600736, 
             161632.824728207, 155717.543666899, 120458.850146998, 105901.510178213, 
             100124.019554106, 96603.7480050248, 122618.591994351, 120160.800645344, 
             145984.846787409, 250999.376791635, 362795.098550697, 404524.532256194, 
             375864.874738234, 329231.000190321, 279981.335065895, 289788.137766149, 
             261450.506564876, 224297.049802603, 205368.707839178, 280645.730124576, 
             515629.769685169, 527284.863214442, 497506.305889897, 535635.318341746, 
             537884.847594419, 516387.271137928, 509950.939974638, 474587.852422984, 
             371023.147769951, 305414.302047374, 299816.12633913, 257532.767815075, 
             292201.635784506, 266363.90247433, 236219.455870915, 546058.658400098, 
             578987.261538636, 489714.226932189, 383186.711693294, 358954.95736469, 
             340773.844974577, 336392.194464568, 389630.425475279, 359373.971848824, 
             337506.665484287, 346819.115823468, 307101.641079513, 256898.459924, 
             328942.558383934, 310682.591166016, 296800.804110566, 238059.255321603, 
             230739.93536548, 338667.384205143, 449285.171586773, 447860.894207534, 
             395255.987509593, 378357.55400027, 301370.751428572, 228776.010652472, 
             166264.754543462, 154457.295605016, 201496.890269195, 240833.160609645, 
             299669.806850176, 357727.803671782, 430008.882976962, 405332.353740941, 
             438952.481493311, 381992.274475, 343458.362008726, 320397.667929379, 
             335295.472147385, 291372.802550646, 253898.233123277, 251732.375719257, 
             230440.120213566, 224266.853782502, 220523.220141702, 207248.301130999, 
             181626.942706933, 182546.422331188, 169952.90409414, 155230.027417332, 
             190514.183934608, 269183.346796695, 292842.424056842, 278631.986970755, 
             316353.364740949, 323409.750389689, 318420.174433485, 314300.955384708, 
             406794.063487045, 533092.306577953, 557539.307908695, 771823.131223767, 
             766456.278352733, 696629.292962943, 560838.769678725, 454830.325880822, 
             339962.283856278, 279609.460448197, 273984.876991923, 274599.187900265, 
             265466.496358251, 326317.041372732, 411316.754687646, 377060.63747427, 
             401486.71915001, 343129.469322447, 297018.059337589, 246822.551981164, 
             225815.72589563, 197122.768883479, 165007.945323518, 248715.387920542, 
             287621.104259641, 342946.189777869, 331931.815034443, 334180.268511862, 
             402337.911250058, 372293.331554495, 331571.824978573, 267601.138225784, 
             253586.687798975, 214133.896191352, 226303.141825967, 238854.030524449, 
             266069.746793815, 351503.284429545, 331102.017766115, 275111.947279814, 
             225693.585559319, 209395.184835097, 316549.180848517, 299872.184457433, 
             252781.61784491, 189004.002717719, 166131.735043227, 120316.742913775, 
             115794.42985645, 109418.987740449)
# curly.phi <- rnorm(1,0,sig.s) # random deviations on top of the autocorrelation
# epsilon.curr <- rho * epsilon.prev + sqrt(1-(rho^2)) * curly.phi # error in the current year
sigma.test <- seq(0.25,0.35, length.out =50)
tim.params$sigma0=0.2
sigma.save <- matrix(NA,2,length(sigma.test))
#tim.params$sigma0 <- sigma_est

for (i in 1:length(sigma.test)){

obs.ts <-eps.vec <- obs.ts.ac <-vector()
obs.ts[1] <- test.ts[1]*exp(rnorm(1,0,(1/tim.params$tau0^2 +1/tim.params$sigma0^2)^(-0.5)))


sig.s2 <- sigma.test[i] #(1/tim.params$tau0^2 +1/tim.params$sigma0^2)^(-0.5) # diff values
curly.phi2 <- rnorm(1,0,sig.s2) # random deviations on top of the autocorrelation

#epsilon.curr2 <- 1 # error in the current year
#err2 <- (epsilon.curr2-(0.5*sig.s2^2))
obs.ts.ac[1] <- test.ts[1] * exp(curly.phi2)

# sig.s <- (1/tim.params$tau0^2 +1/tim.params$sigma0^2)^(-0.5) # target sd 0.4
eps.vec[1] <- 1

  
for(t in 2:250){
  obs.ts[t] <- tim.assessment(B = test.ts[t],Eprev = obs.ts[t-1],sigma0 = tim.params$sigma0, tau0 = tim.params$tau0)
  est <- add.wied.error(biomass.true = test.ts[t],epsilon.prev = eps.vec[t-1],sig.s = sig.s2,rho=0.5)
  obs.ts.ac[t] <- est$biomass.est
  eps.vec[t] <- est$epsilon.curr
}
# par(mfrow=c(1,1))
# plot(test.ts,type='l')
# lines(obs.ts, col="red")
# lines(obs.ts.ac, col="blue")

 sigma.save[1,i] <- sd(log(test.ts/obs.ts))
 sigma.save[2,i] <-  sd(log(test.ts/obs.ts.ac))
 

}

plot(sigma.test,sigma.save[1,], ylim = c(0.05,0.5))
lines(sigma.test,sigma.save[2,])
# Figure out where these two sigma values intersect; this is where error(AC) ~~ error(DD)




hist(sigma.save[1,])

plot(test.ts, type = 'l')
lines(obs.ts.ac, col = 'blue')
lines(obs.ts, col = 'red')


epis.prev <- 1
rho <- 0

tau0 <- 0.5

sig.1 <- 0.4 # Specify the sd on 'add wied error'

sigma_est <- (1/(0.1^(-2)-1/tau0^2))^0.5 # Calculate the value for sigma2 given tau - max value is 0.5 (inf)
sig.2 <-sigma_est # specifiy the sd on 'tim.assessment'
sigma0 <- sig.2
ntest <- vector()
ntest2 <- vector()

for (i in 1:10000){ # Test it numerically
ntest[i] <-add.wied.error(epis.prev,sig.1,rho)
ntest2[i] <- tim.assessment(tau0, sig.2)
}

par(mfrow = c(2,1), mar = c(4,4,1,1))
nmean <- mean(ntest)
nsd <- sd(ntest)
x <- seq(-5,5, length.out = 100)
h <- hist(ntest, breaks = 20, density = 10,
          col = "gray",  main = paste('SD = ',format(nsd, digits = 2),', mean = ',format(nmean, digits = 2)))
xfit <- seq(min(ntest), max(ntest), length = 40) 
yfit <- dnorm(xfit, mean = mean(ntest), sd = sd(ntest)) 
yfit <- yfit * diff(h$mids[1:2]) * length(ntest) 

lines(xfit, yfit, col = "black", lwd = 2)

test.ts <- testie$biomass.oneplus.true
sd(ntest)
sd(ntest2)
sd(test.ts*ntest[1:250])
sd(test.ts*ntest2[1:250])

# Try the other error model and test the algebra
nmean <- mean(ntest2)
nsd <- sd(ntest2)
x <- seq(-5,5, length.out = 100)
h <- hist(ntest2, breaks = 20, density = 10,
          col = "gray", main = paste('SD = ',format(nsd, digits = 2),', mean = ',format(nmean, digits = 2))) 
xfit <- seq(min(ntest2), max(ntest2), length = 40) 
yfit <- dnorm(xfit, mean = mean(ntest2), sd = sd(ntest2)) 
yfit <- yfit * diff(h$mids[1:2]) * length(ntest2) 
lines(xfit, yfit, col = "black", lwd = 2)

sigma.crossval <- sqrt(mean(test.ts[2:250] / test.ts[1:249]) / 0.5)
